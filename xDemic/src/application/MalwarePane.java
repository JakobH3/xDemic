package application;

import java.util.Random;

import javafx.beans.value.ChangeListener;
import javafx.beans.value.ObservableValue;
import javafx.scene.control.Button;
import javafx.scene.control.ScrollPane;
import javafx.scene.control.Slider;
import javafx.scene.control.TextField;
import javafx.scene.layout.HBox;
import javafx.scene.layout.VBox;
import javafx.scene.text.Text;

public class MalwarePane extends ScrollPane {
	private MainView mainView;
	
	private VBox malwareList;
	
	private Random random = new Random();
	
	public MalwarePane(MainView mainView) {
		this.mainView = mainView;
		
		setMinWidth(200);
		setMinHeight(400);
		
		malwareList = new VBox();
		setContent(malwareList);
	}
	
	public void update() {
		setPrefWidth(mainView.getWidth()/5);
		setPrefHeight(mainView.getHeight()*2/3-mainView.getTools().getHeight());
		
		malwareList.getChildren().clear();
		
		if(!mainView.getSimulation().getMalwareList().isEmpty()) {
			for(int i=0; i<mainView.getSimulation().getMalwareList().size(); i++) {
				VBox malware = new VBox();
				malware.getStyleClass().add("malware");
				
				int id = i;
				
				Text name = new Text("Name: " + mainView.getSimulation().getMalwareList().get(i).getName());
				Text infect = new Text("Chance of Infection: " + String.format("%.2f", mainView.getSimulation().getMalwareList().get(i).getChanceInfection()) + "%");
				Text patch = new Text("Patch Release: " + mainView.getSimulation().getMalwareList().get(i).getPatchRelease());
				Button remove = new Button("Remove");
				remove.setOnAction((e) -> {
					// remove malware from all devices
					for(int j=0; j<mainView.getSimulation().getDeviceList().size(); j++) {
						if(mainView.getSimulation().getDeviceList().get(j).getMalwareList().contains(mainView.getSimulation().getMalwareList().get(id))) {
							mainView.getSimulation().getDeviceList().get(j).getMalwareList().remove(mainView.getSimulation().getMalwareList().get(id));
						}
						if(mainView.getSimulation().getDeviceList().get(j).getPatchedMalwareList().contains(mainView.getSimulation().getMalwareList().get(id))) {
							mainView.getSimulation().getDeviceList().get(j).getPatchedMalwareList().remove(mainView.getSimulation().getMalwareList().get(id));
						}
					}
					// remove malware from malwareList
					mainView.getSimulation().getMalwareList().remove(id);
					mainView.draw();
				});
				malware.getChildren().addAll(name, infect, patch, remove);
				
				malwareList.getChildren().add(malware);
			}
		}
	}
	
	public void add() {
		if(mainView.editing()) {		
			VBox options = new VBox(10);
			options.getStyleClass().add("options");
			
			double chanceInfectionDefault=100*random.nextDouble(), patchReleaseDefault=random.nextInt(100);
			
			Text nameLabel = new Text("Name");
			TextField name = new TextField();
			
			Text chanceInfectionLabel = new Text("The probability of infection is ");
			Text chanceInfectionValue = new Text(String.format("%.1f", chanceInfectionDefault) + "%");
			Slider chanceInfection = new Slider(0, 100, chanceInfectionDefault);
			chanceInfection.valueProperty().addListener(new ChangeListener<Number>() {
				public void changed(ObservableValue <? extends Number > observable, Number oldValue, Number newValue) {
					chanceInfectionValue.setText(String.format("%.1f", newValue) + "%");
				}
			});
			
			Text patchReleaseLabel = new Text("The patch will release on frame ");
			Text patchReleaseValue = new Text(String.format("%.0f", patchReleaseDefault));
			Slider patchRelease = new Slider(0, 100, patchReleaseDefault);
			patchRelease.valueProperty().addListener(new ChangeListener<Number>() {
				public void changed(ObservableValue <? extends Number > observable, Number oldValue, Number newValue) {
					patchReleaseValue.setText(String.format("%.0f", newValue));
				}
			});
			
			Button apply = new Button("Apply");
			apply.setOnAction((e) -> {
				if((name.getText() != null && !name.getText().isEmpty())) {
					mainView.getSimulation().getMalwareList().add(new Malware(name.getText(), chanceInfection.getValue(), (int)patchRelease.getValue()));
		        } else {
		        	mainView.getSimulation().getMalwareList().add(new Malware("Undefined", chanceInfection.getValue(), (int)patchRelease.getValue()));
		        }
				mainView.setCenter(mainView.getOutput());
				mainView.draw();
			});
		
			Button cancel = new Button("Cancel");
			cancel.setOnAction((e) -> {
				mainView.setCenter(mainView.getOutput());
				mainView.draw();
			});
			
			options.getChildren().addAll(nameLabel, name, new HBox(chanceInfectionLabel, chanceInfectionValue), chanceInfection, new HBox(patchReleaseLabel, patchReleaseValue), patchRelease, new HBox(apply, cancel));
			mainView.setCenter(options);
		}
	}
}